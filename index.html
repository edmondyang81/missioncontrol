<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mission Control - Full Featured</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; 
            background: #0d0d0d; 
            color: #fff; 
            min-height: 100vh;
        }
        .header { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            padding: 1rem 2rem; 
            background: #1a1a1a; 
            border-bottom: 1px solid #333;
        }
        .header-left { display: flex; align-items: center; gap: 2rem; }
        .logo { font-size: 1.25rem; font-weight: 600; display: flex; align-items: center; gap: 0.5rem; }
        .nav-tabs { display: flex; gap: 0.5rem; }
        .nav-tab { 
            padding: 0.5rem 1rem; 
            border-radius: 6px; 
            cursor: pointer; 
            color: #a0a0a0;
            transition: all 0.2s;
        }
        .nav-tab.active { background: #262626; color: #fff; }
        
        .board { 
            display: flex; 
            gap: 16px; 
            padding: 20px; 
            overflow-x: auto;
            min-height: calc(100vh - 80px);
        }
        .column { 
            min-width: 320px; 
            background: #1a1a1a; 
            border-radius: 8px; 
            padding: 12px;
            display: flex;
            flex-direction: column;
        }
        .column-header { 
            display: flex; 
            justify-content: space-between;
            align-items: center;
            padding-bottom: 12px;
            margin-bottom: 12px;
            border-bottom: 1px solid #333;
            font-weight: 600;
        }
        .column-count { 
            background: #333; 
            padding: 2px 10px; 
            border-radius: 12px; 
            font-size: 0.85rem;
        }
        .column-tasks {
            flex: 1;
            min-height: 100px;
            padding: 4px;
        }
        .column-tasks.drag-over {
            background: #262626;
            border-radius: 6px;
        }
        
        .task { 
            background: #262626; 
            padding: 12px; 
            border-radius: 6px; 
            margin-bottom: 10px;
            border: 1px solid #333;
            cursor: grab;
            transition: all 0.2s;
        }
        .task:hover { 
            border-color: #3b82f6;
            transform: translateY(-2px);
        }
        .task.dragging {
            opacity: 0.5;
            cursor: grabbing;
        }
        .task-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 8px;
        }
        .task-title { 
            font-weight: 500; 
            font-size: 0.95rem;
            line-height: 1.4;
            flex: 1;
        }
        .task-priority {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-left: 8px;
            flex-shrink: 0;
        }
        .priority-high { background: #ef4444; }
        .priority-medium { background: #f59e0b; }
        .priority-low { background: #10b981; }
        
        .task-desc {
            font-size: 0.85rem;
            color: #a0a0a0;
            margin-bottom: 10px;
            line-height: 1.4;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
        
        .task-meta {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            align-items: center;
        }
        .tag {
            background: #333;
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 0.75rem;
            color: #ccc;
        }
        .project-tag {
            background: #3b82f6;
            color: white;
        }
        .subtask-count {
            font-size: 0.8rem;
            color: #888;
            margin-left: auto;
        }
        
        /* Modal */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.85);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        .modal-overlay.active {
            display: flex;
        }
        .modal {
            background: #1a1a1a;
            border-radius: 12px;
            width: 100%;
            max-width: 700px;
            max-height: 90vh;
            overflow-y: auto;
            border: 1px solid #333;
        }
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 24px;
            border-bottom: 1px solid #333;
        }
        .modal-title {
            font-size: 1.25rem;
            font-weight: 600;
        }
        .modal-close {
            background: none;
            border: none;
            color: #888;
            font-size: 1.5rem;
            cursor: pointer;
            padding: 0;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 6px;
        }
        .modal-close:hover {
            background: #333;
            color: #fff;
        }
        
        /* Login Modal */
        .login-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #0d0d0d;
            z-index: 2000;
            display: none;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        .login-overlay.active {
            display: flex;
        }
        .login-box {
            background: #1a1a1a;
            border-radius: 12px;
            width: 100%;
            max-width: 400px;
            padding: 32px;
            border: 1px solid #333;
            text-align: center;
        }
        .login-box .logo {
            font-size: 2rem;
            margin-bottom: 8px;
            justify-content: center;
        }
        .login-box h2 {
            margin-bottom: 8px;
            color: #fff;
        }
        .login-box p {
            color: #888;
            margin-bottom: 24px;
            font-size: 0.9rem;
        }
        .login-input {
            width: 100%;
            padding: 12px 16px;
            background: #262626;
            border: 1px solid #333;
            border-radius: 8px;
            color: #fff;
            font-size: 0.9rem;
            margin-bottom: 16px;
            font-family: monospace;
        }
        .login-input:focus {
            outline: none;
            border-color: #3b82f6;
        }
        .login-btn {
            width: 100%;
            padding: 12px;
            background: #3b82f6;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            cursor: pointer;
            transition: background 0.2s;
        }
        .login-btn:hover {
            background: #2563eb;
        }
        .login-help {
            margin-top: 16px;
            font-size: 0.8rem;
            color: #666;
        }
        .login-help a {
            color: #3b82f6;
        }
        
        /* User status in header */
        .user-status {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 6px 12px;
            background: #262626;
            border-radius: 8px;
            font-size: 0.9rem;
        }
        .user-status .username {
            color: #fff;
            font-weight: 500;
        }
        .user-status .logout-btn {
            background: #333;
            color: #888;
            border: none;
            padding: 4px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.8rem;
            transition: all 0.2s;
        }
        .user-status .logout-btn:hover {
            background: #444;
            color: #fff;
        }
        
        .modal-body {
            padding: 24px;
        }
        
        .detail-section {
            margin-bottom: 24px;
        }
        .detail-section h3 {
            font-size: 0.9rem;
            color: #888;
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .detail-section p {
            line-height: 1.6;
            color: #ccc;
        }
        
        .subtasks-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        .subtask-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 12px;
            background: #262626;
            border-radius: 6px;
        }
        .subtask-item input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }
        .subtask-item span {
            flex: 1;
        }
        .subtask-item.done span {
            text-decoration: line-through;
            color: #666;
        }
        
        .comments-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        .comment {
            padding: 12px;
            background: #262626;
            border-radius: 6px;
        }
        .comment-author {
            font-weight: 600;
            font-size: 0.9rem;
            margin-bottom: 4px;
        }
        .comment-time {
            font-size: 0.75rem;
            color: #666;
            margin-bottom: 8px;
        }
        .comment-text {
            color: #ccc;
            line-height: 1.5;
        }
        
        .move-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }
        .btn {
            padding: 8px 16px;
            border-radius: 6px;
            border: none;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.2s;
        }
        .btn-primary {
            background: #3b82f6;
            color: white;
        }
        .btn-primary:hover {
            background: #2563eb;
        }
        .btn-secondary {
            background: #333;
            color: #fff;
        }
        .btn-secondary:hover {
            background: #444;
        }
        
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #666;
        }
        
        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #1a1a1a;
        }
        ::-webkit-scrollbar-thumb {
            background: #444;
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
    </style>
</head>
<body>
    <div class="login-overlay" id="loginOverlay">
        <div class="login-box">
            <div class="logo"><span>üéØ</span></div>
            <h2>Welcome to Mission Control</h2>
            <p>Connect your GitHub account to sync tasks</p>
            <input type="password" id="tokenInput" class="login-input" placeholder="ghp_xxxxxxxxxxxxxxxxxxxx">
            <button class="login-btn" onclick="connectGitHub()">Connect</button>
            <div class="login-help">
                Need a token? <a href="https://github.com/settings/tokens" target="_blank">Create one here</a><br>
                Required scope: <code>repo</code>
            </div>
        </div>
    </div>

    <header class="header">
        <div class="header-left">
            <div class="logo">
                <span>üéØ</span>
                <span>Mission Control</span>
            </div>
            <nav class="nav-tabs">
                <div class="nav-tab active">Tasks</div>
            </nav>
        </div>
        <div style="display: flex; align-items: center; gap: 12px;">
            <div id="userStatus" class="user-status" style="display: none;">
                <span>üë§</span>
                <span class="username" id="username">Not connected</span>
                <button class="logout-btn" onclick="logout()">Logout</button>
            </div>
            <label style="display: flex; align-items: center; gap: 6px; cursor: pointer; color: #888; font-size: 0.9rem;">
                <input type="checkbox" id="autoSaveCheckbox" style="cursor: pointer;">
                Auto-save
            </label>
            <button id="saveBtn" class="btn btn-primary" onclick="saveToGitHub()" style="display: flex; align-items: center; gap: 6px;">
                <span>üíæ</span> Save to GitHub
            </button>
            <span id="saveStatus" style="color: #888; font-size: 0.85rem; min-width: 120px;"></span>
            <span style="color: #888;">üéõÔ∏è Local Mode</span>
        </div>
    </header>

    <div class="board" id="board"></div>

    <div class="modal-overlay" id="modal">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title" id="modalTitle">Task Details</div>
                <button class="modal-close" onclick="closeModal()">&times;</button>
            </div>
            <div class="modal-body" id="modalBody"></div>
        </div>
    </div>

    <script>
        // Full task data
        const TASKS_DATA = {
            "tasks": [
                {
                    "id": "guide_onboarding",
                    "title": "üöÄ Onboarding Guide ‚Äî Set Up Mission Control",
                    "description": "Welcome to Mission Control! Follow these steps to complete your setup. Work through each subtask in order.\\n\\n**Tip:** Click on a subtask to see detailed instructions. Check it off when done.",
                    "status": "permanent",
                    "project": "guides",
                    "tags": ["guide", "setup"],
                    "subtasks": [
                        {"id": "sub_001", "title": "1. Enable GitHub Pages: Settings ‚Üí Pages ‚Üí Branch: main ‚Üí Save", "done": true},
                        {"id": "sub_002", "title": "2. Create GitHub Token: github.com/settings/tokens ‚Üí Generate (classic) ‚Üí Scope: repo", "done": true},
                        {"id": "sub_003", "title": "3. Connect Dashboard: Open your GitHub Pages URL ‚Üí Click 'Connect GitHub' ‚Üí Paste token", "done": true},
                        {"id": "sub_004", "title": "4. Install Tailscale: brew install tailscale && tailscale up", "done": false},
                        {"id": "sub_005", "title": "5. Enable Funnel: tailscale funnel 18789 ‚Üí Copy your URL", "done": false},
                        {"id": "sub_006", "title": "6. Generate Webhook Token: openssl rand -hex 32 ‚Üí Save it", "done": false},
                        {"id": "sub_007", "title": "7. Add GitHub Webhook: Settings ‚Üí Webhooks ‚Üí Add ‚Üí URL: https://YOUR-TAILSCALE-URL/hooks/github?token=YOUR-TOKEN", "done": false},
                        {"id": "sub_008", "title": "8. Test: Create a task, move to In Progress, verify MoltBot receives notification", "done": false}
                    ],
                    "priority": "high",
                    "comments": [
                        {"author": "Mission Control", "text": "Once all steps are complete, you can archive this guide or keep it as reference. Your setup is done when MoltBot responds to task changes!", "timestamp": "2026-01-01T00:00:00Z"}
                    ],
                    "createdAt": "2026-01-01T00:00:00Z"
                },
                {
                    "id": "guide_user",
                    "title": "üìñ User Guide ‚Äî How to Use Mission Control",
                    "description": "Learn how to use Mission Control effectively. Both you AND MoltBot can manage tasks!\\n\\n**Two ways to manage tasks:**\\n‚Ä¢ üë§ **You** ‚Äî Use the Dashboard UI (drag & drop, buttons, forms)\\n‚Ä¢ ü§ñ **MoltBot** ‚Äî Uses CLI scripts or edits tasks.json directly",
                    "status": "permanent",
                    "project": "guides",
                    "tags": ["guide", "help"],
                    "subtasks": [
                        {"id": "sub_001", "title": "‚Äî THE BOARD ‚Äî", "done": false},
                        {"id": "sub_002", "title": "Columns: Permanent (recurring) ‚Üí Backlog ‚Üí In Progress ‚Üí Review ‚Üí Done", "done": false},
                        {"id": "sub_003", "title": "Drag & Drop: Move tasks between columns to change status", "done": false},
                        {"id": "sub_004", "title": "Click task card to open details and edit", "done": false}
                    ],
                    "priority": "medium",
                    "comments": [
                        {"author": "Mission Control", "text": "This guide stays in Permanent so you can always reference it. The subtasks aren't meant to be 'completed' ‚Äî they're documentation!", "timestamp": "2026-01-01T00:00:00Z"}
                    ],
                    "createdAt": "2026-01-01T00:00:01Z"
                },
                {
                    "id": "leia_daily",
                    "title": "ü§ñ Leia ‚Äî Daily Tasks & Checks",
                    "description": "Daily recurring tasks for Leia to check and maintain.\\n\\n**Includes:**\\n- Check emails\\n- Check calendar\\n- Monitor Moltbook status\\n- Review Mission Control tasks\\n- Update daily notes",
                    "status": "permanent",
                    "project": "leia",
                    "tags": ["daily", "automation", "leia"],
                    "subtasks": [
                        {"id": "sub_001", "title": "Check emails for urgent messages", "done": false},
                        {"id": "sub_002", "title": "Review calendar for upcoming events", "done": false},
                        {"id": "sub_003", "title": "Check Moltbook status (every 2 hours)", "done": false},
                        {"id": "sub_004", "title": "Review Mission Control tasks in 'In Progress'", "done": false},
                        {"id": "sub_005", "title": "Update daily notes in memory/", "done": false}
                    ],
                    "priority": "high",
                    "comments": [],
                    "createdAt": "2026-02-02T12:00:00Z"
                },
                {
                    "id": "leia_photoshop",
                    "title": "üé® Photoshop MCP Integration",
                    "description": "Complete Photoshop MCP server setup and create useful automation scripts.\\n\\n**Status:** Server installed, UXP plugin needs loading in Photoshop",
                    "status": "in_progress",
                    "project": "leia",
                    "tags": ["photoshop", "automation", "mcp"],
                    "subtasks": [
                        {"id": "sub_001", "title": "Install Adobe-MCP Python package", "done": true},
                        {"id": "sub_002", "title": "Start proxy server (ws://localhost:3001)", "done": true},
                        {"id": "sub_003", "title": "Load UXP plugin in Photoshop", "done": false},
                        {"id": "sub_004", "title": "Test creating documents via MCP", "done": false},
                        {"id": "sub_005", "title": "Create batch processing scripts", "done": false}
                    ],
                    "priority": "medium",
                    "comments": [
                        {"author": "Leia", "text": "Proxy server is running. Need Edmond to load the UXP plugin in Photoshop to complete setup.", "timestamp": "2026-02-02T11:30:00Z"}
                    ],
                    "createdAt": "2026-02-02T10:00:00Z"
                },
                {
                    "id": "leia_moltbook",
                    "title": "üì° Moltbook Account Recovery",
                    "description": "Monitor and recover Moltbook account status. Account was banned due to aggressive posting, now monitoring for unban.\\n\\n**API Key:** moltbook_sk_Yd10CWTQ2_u2k31FEbhDCrsvgWecKx7I",
                    "status": "review",
                    "project": "leia",
                    "tags": ["moltbook", "monitoring", "social"],
                    "subtasks": [
                        {"id": "sub_001", "title": "Account banned - aggressive posting detected", "done": true},
                        {"id": "sub_002", "title": "Disabled autopost cron jobs", "done": true},
                        {"id": "sub_003", "title": "Set up monitoring (every 2 hours)", "done": true},
                        {"id": "sub_004", "title": "Account unbanned - Feb 1, 21:34", "done": true},
                        {"id": "sub_005", "title": "Account banned again - Feb 2, 11:50", "done": true},
                        {"id": "sub_006", "title": "Wait for automatic unban or contact support", "done": false}
                    ],
                    "priority": "low",
                    "comments": [
                        {"author": "Leia", "text": "Account was temporarily unbanned on Feb 1 but banned again on Feb 2. Continuing to monitor every 2 hours via cron job.", "timestamp": "2026-02-02T11:50:00Z"}
                    ],
                    "createdAt": "2026-02-01T12:00:00Z"
                },
                {
                    "id": "leia_skills",
                    "title": "üõ†Ô∏è Install & Configure Skills",
                    "description": "Install and configure useful OpenClaw skills for automation and productivity.\\n\\n**Skills to install:**\\n- Mission Control (task management) ‚úÖ Done\\n- Photoshop MCP (image editing)\\n- Instagram downloader\\n- Other useful tools",
                    "status": "in_progress",
                    "project": "leia",
                    "tags": ["skills", "setup", "automation"],
                    "subtasks": [
                        {"id": "sub_001", "title": "Install Mission Control skill", "done": true},
                        {"id": "sub_002", "title": "Set up GitHub Pages hosting", "done": true},
                        {"id": "sub_003", "title": "Configure auto-save", "done": true},
                        {"id": "sub_004", "title": "Create Instagram downloader skill", "done": true},
                        {"id": "sub_005", "title": "Set up webhook integration", "done": false}
                    ],
                    "priority": "high",
                    "comments": [
                        {"author": "Leia", "text": "Mission Control is now live at https://edmondyang81.github.io/missioncontrol/ with auto-save enabled!", "timestamp": "2026-02-02T12:00:00Z"}
                    ],
                    "createdAt": "2026-02-02T09:00:00Z"
                },
                {
                    "id": "instagram_content",
                    "title": "üì± Instagram Content Creation",
                    "description": "Create and schedule Instagram content for Edmond's AI video projects.\\n\\n**Focus areas:**\\n- AI video experiments\\n- Trending memes to AI videos\\n- Behind-the-scenes workflow\\n- Client acquisition posts",
                    "status": "backlog",
                    "project": "content",
                    "tags": ["instagram", "content", "marketing"],
                    "subtasks": [
                        {"id": "sub_001", "title": "Download trending memes for AI conversion", "done": false},
                        {"id": "sub_002", "title": "Create AI video from meme", "done": false},
                        {"id": "sub_003", "title": "Write engaging captions", "done": false},
                        {"id": "sub_004", "title": "Schedule posts for optimal times", "done": false}
                    ],
                    "priority": "medium",
                    "comments": [],
                    "createdAt": "2026-02-02T11:00:00Z"
                },
                {
                    "id": "redgala_script",
                    "title": "üé¨ RedGala - Hope's Wild Dream Script",
                    "description": "Complete script translation and PDF creation for RedGala project. Story about sheep Hope who dreams of becoming a sheepdog.\\n\\n**Status:** Scene 1 and 2 translated to English, PDFs created",
                    "status": "review",
                    "project": "redgala",
                    "tags": ["script", "translation", "pdf"],
                    "subtasks": [
                        {"id": "sub_001", "title": "Translate Chinese script to English", "done": true},
                        {"id": "sub_002", "title": "Create clean PDF (no Chinese characters)", "done": true},
                        {"id": "sub_003", "title": "Review with Edmond", "done": false},
                        {"id": "sub_004", "title": "Translate remaining scenes if needed", "done": false}
                    ],
                    "priority": "medium",
                    "comments": [
                        {"author": "Leia", "text": "Created hope_complete.pdf and hope_script_english.pdf. Files saved in workspace. Awaiting review.", "timestamp": "2026-02-01T18:00:00Z"}
                    ],
                    "createdAt": "2026-02-01T12:00:00Z"
                },
                {
                    "id": "man_united_tracker",
                    "title": "üî¥ Man United Match Tracker",
                    "description": "Track Manchester United matches and send reminders to Edmond.\\n\\n**Setup:** Automated Sunday reminders at 13:45 (45 mins before kickoff)",
                    "status": "backlog",
                    "project": "automation",
                    "tags": ["sports", "automation", "cron"],
                    "subtasks": [
                        {"id": "sub_001", "title": "Set up automated match checking", "done": true},
                        {"id": "sub_002", "title": "Generate match preview images", "done": false},
                        {"id": "sub_003", "title": "Send WhatsApp reminders", "done": true},
                        {"id": "sub_004", "title": "Post-match summaries with results", "done": true}
                    ],
                    "priority": "low",
                    "comments": [
                        {"author": "Leia", "text": "Next match reminder: Every Sunday 13:45. Will generate image of Edmond at Old Trafford and send WhatsApp message.", "timestamp": "2026-02-01T19:00:00Z"}
                    ],
                    "createdAt": "2026-02-01T14:00:00Z"
                }
            ]
        };

        const COLUMNS = [
            { id: 'permanent', title: 'Permanent' },
            { id: 'backlog', title: 'Backlog' },
            { id: 'in_progress', title: 'In Progress' },
            { id: 'review', title: 'Review' },
            { id: 'done', title: 'Done' }
        ];

        let draggedTask = null;
        let currentTask = null;

        function init() {
            renderBoard();
            console.log('Mission Control loaded with', TASKS_DATA.tasks.length, 'tasks');
        }

        function renderBoard() {
            const board = document.getElementById('board');
            board.innerHTML = '';

            COLUMNS.forEach(col => {
                const tasks = TASKS_DATA.tasks.filter(t => t.status === col.id);
                
                const colDiv = document.createElement('div');
                colDiv.className = 'column';
                colDiv.innerHTML = `
                    <div class="column-header">
                        <span>${col.title}</span>
                        <span class="column-count">${tasks.length}</span>
                    </div>
                    <div class="column-tasks" data-status="${col.id}" ondrop="handleDrop(event, '${col.id}')" ondragover="handleDragOver(event)" ondragleave="handleDragLeave(event)">
                        ${tasks.length === 0 ? '<div class="empty-state" style="pointer-events: none;">Drop tasks here</div>' : ''}
                    </div>
                `;
                
                const tasksContainer = colDiv.querySelector('.column-tasks');
                tasks.forEach(task => {
                    const taskEl = createTaskElement(task);
                    tasksContainer.appendChild(taskEl);
                });
                
                board.appendChild(colDiv);
            });
        }

        function createTaskElement(task) {
            const el = document.createElement('div');
            el.className = 'task';
            el.draggable = true;
            el.dataset.taskId = task.id;
            
            const doneSubtasks = task.subtasks.filter(s => s.done).length;
            const totalSubtasks = task.subtasks.length;
            
            el.innerHTML = `
                <div class="task-header">
                    <div class="task-title">${escapeHtml(task.title)}</div>
                    <div class="task-priority priority-${task.priority}"></div>
                </div>
                <div class="task-desc">${escapeHtml(task.description.substring(0, 100))}${task.description.length > 100 ? '...' : ''}</div>
                <div class="task-meta">
                    <span class="tag project-tag">${task.project}</span>
                    ${task.tags.map(t => `<span class="tag">${t}</span>`).join('')}
                    ${totalSubtasks > 0 ? `<span class="subtask-count">‚òëÔ∏è ${doneSubtasks}/${totalSubtasks}</span>` : ''}
                </div>
            `;
            
            el.addEventListener('dragstart', handleDragStart);
            el.addEventListener('dragend', handleDragEnd);
            el.addEventListener('click', () => openTask(task));
            
            return el;
        }

        function handleDragStart(e) {
            draggedTask = TASKS_DATA.tasks.find(t => t.id === e.target.dataset.taskId);
            e.target.classList.add('dragging');
            e.dataTransfer.effectAllowed = 'move';
            e.dataTransfer.setData('text/plain', e.target.dataset.taskId);
        }

        function handleDragEnd(e) {
            e.target.classList.remove('dragging');
            document.querySelectorAll('.column-tasks').forEach(col => {
                col.classList.remove('drag-over');
            });
        }

        function handleDragOver(e) {
            e.preventDefault();
            e.dataTransfer.dropEffect = 'move';
            e.currentTarget.classList.add('drag-over');
        }

        function handleDragLeave(e) {
            // Only remove drag-over if we're actually leaving the container (not entering a child)
            if (!e.currentTarget.contains(e.relatedTarget)) {
                e.currentTarget.classList.remove('drag-over');
            }
        }

        function handleDrop(e, newStatus) {
            e.preventDefault();
            e.stopPropagation();
            
            // Find the column-tasks container (handle bubbling from child elements)
            let target = e.target;
            while (target && !target.classList.contains('column-tasks')) {
                target = target.parentElement;
            }
            if (target) {
                target.classList.remove('drag-over');
            }
            
            // Get task ID from dataTransfer as fallback
            const taskId = e.dataTransfer.getData('text/plain');
            const taskToMove = draggedTask || TASKS_DATA.tasks.find(t => t.id === taskId);
            
            if (taskToMove && taskToMove.status !== newStatus) {
                taskToMove.status = newStatus;
                renderBoard();
                markAsChanged();
                console.log(`Moved "${taskToMove.title}" to ${newStatus}`);
            }
            draggedTask = null;
        }

        function openTask(task) {
            currentTask = task;
            document.getElementById('modalTitle').textContent = task.title;
            
            const doneCount = task.subtasks.filter(s => s.done).length;
            
            document.getElementById('modalBody').innerHTML = `
                <div class="detail-section">
                    <h3>Description</h3>
                    <p>${escapeHtml(task.description).replace(/\\n/g, '<br>')}</p>
                </div>
                
                <div class="detail-section">
                    <h3>Details</h3>
                    <p><strong>Project:</strong> ${task.project}</p>
                    <p><strong>Status:</strong> ${task.status}</p>
                    <p><strong>Priority:</strong> ${task.priority}</p>
                    <p><strong>Created:</strong> ${new Date(task.createdAt).toLocaleDateString()}</p>
                </div>
                
                ${task.subtasks.length > 0 ? `
                <div class="detail-section">
                    <h3>Subtasks (${doneCount}/${task.subtasks.length})</h3>
                    <div class="subtasks-list">
                        ${task.subtasks.map((s, i) => `
                            <div class="subtask-item ${s.done ? 'done' : ''}">
                                <input type="checkbox" ${s.done ? 'checked' : ''} onchange="toggleSubtask(${i})">
                                <span>${escapeHtml(s.title)}</span>
                            </div>
                        `).join('')}
                    </div>
                </div>
                ` : ''}
                
                ${task.comments.length > 0 ? `
                <div class="detail-section">
                    <h3>Comments</h3>
                    <div class="comments-list">
                        ${task.comments.map(c => `
                            <div class="comment">
                                <div class="comment-author">${escapeHtml(c.author)}</div>
                                <div class="comment-time">${new Date(c.timestamp).toLocaleString()}</div>
                                <div class="comment-text">${escapeHtml(c.text)}</div>
                            </div>
                        `).join('')}
                    </div>
                </div>
                ` : ''}
                
                <div class="detail-section">
                    <h3>Move to Column</h3>
                    <div class="move-buttons">
                        ${COLUMNS.filter(c => c.id !== task.status).map(c => `
                            <button class="btn btn-secondary" onclick="moveTask('${c.id}')">${c.title}</button>
                        `).join('')}
                    </div>
                </div>
            `;
            
            document.getElementById('modal').classList.add('active');
        }

        function closeModal() {
            document.getElementById('modal').classList.remove('active');
            currentTask = null;
        }

        function moveTask(newStatus) {
            if (currentTask) {
                currentTask.status = newStatus;
                renderBoard();
                markAsChanged();
                closeModal();
            }
        }

        function toggleSubtask(idx) {
            if (currentTask && currentTask.subtasks[idx]) {
                currentTask.subtasks[idx].done = !currentTask.subtasks[idx].done;
                openTask(currentTask); // Refresh modal
                renderBoard(); // Refresh board
                markAsChanged();
            }
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Close modal on overlay click
        document.getElementById('modal').addEventListener('click', (e) => {
            if (e.target === document.getElementById('modal')) {
                closeModal();
            }
        });

        // Close modal on Escape key
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                closeModal();
            }
        });

        // GitHub save functionality
        let hasUnsavedChanges = false;
        const GITHUB_REPO = 'edmondyang81/missioncontrol';
        const GITHUB_FILE_PATH = 'data/tasks.json';

        // Track changes
        function markAsChanged() {
            hasUnsavedChanges = true;
            updateSaveStatus('unsaved');
            
            // Auto-save if enabled
            if (document.getElementById('autoSaveCheckbox')?.checked) {
                debouncedSave();
            }
        }

        function updateSaveStatus(status, message = '') {
            const statusEl = document.getElementById('saveStatus');
            if (!statusEl) return;
            
            switch(status) {
                case 'unsaved':
                    statusEl.textContent = '‚óè Unsaved';
                    statusEl.style.color = '#f59e0b';
                    break;
                case 'saving':
                    statusEl.textContent = '‚è≥ Saving...';
                    statusEl.style.color = '#3b82f6';
                    break;
                case 'saved':
                    statusEl.textContent = '‚úì Saved';
                    statusEl.style.color = '#10b981';
                    hasUnsavedChanges = false;
                    break;
                case 'error':
                    statusEl.textContent = '‚úó ' + (message || 'Error');
                    statusEl.style.color = '#ef4444';
                    break;
                default:
                    statusEl.textContent = '';
            }
        }

        // Debounced auto-save
        let saveTimeout;
        function debouncedSave() {
            clearTimeout(saveTimeout);
            saveTimeout = setTimeout(() => saveToGitHub(), 2000);
        }

        async function getFileSHA(token) {
            const response = await fetch(`https://api.github.com/repos/${GITHUB_REPO}/contents/${GITHUB_FILE_PATH}`, {
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Accept': 'application/vnd.github.v3+json'
                }
            });

            if (!response.ok) {
                if (response.status === 404) {
                    throw new Error('File not found. Please check the repository and file path.');
                }
                throw new Error(`Failed to get file info: ${response.status}`);
            }

            const fileInfo = await response.json();
            return fileInfo.sha;
        }

        async function commitToGitHub(token, sha) {
            const content = JSON.stringify(TASKS_DATA, null, 2);
            const encodedContent = btoa(unescape(encodeURIComponent(content)));

            const response = await fetch(`https://api.github.com/repos/${GITHUB_REPO}/contents/${GITHUB_FILE_PATH}`, {
                method: 'PUT',
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Accept': 'application/vnd.github.v3+json',
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    message: 'Update tasks via Mission Control dashboard',
                    content: encodedContent,
                    sha: sha
                })
            });

            return response;
        }

        async function saveToGitHub() {
            const token = localStorage.getItem('github_token');
            if (!token) {
                alert('GitHub token not found. Please connect your GitHub account first.');
                updateSaveStatus('error', 'No token');
                return;
            }

            updateSaveStatus('saving');

            const maxRetries = 3;
            let lastError = null;

            for (let attempt = 1; attempt <= maxRetries; attempt++) {
                try {
                    // Always fetch fresh SHA before committing (don't cache it)
                    const sha = await getFileSHA(token);
                    
                    // Attempt to commit
                    const commitResponse = await commitToGitHub(token, sha);

                    if (commitResponse.ok) {
                        updateSaveStatus('saved');
                        
                        // Clear saved status after 3 seconds
                        setTimeout(() => {
                            if (!hasUnsavedChanges) {
                                updateSaveStatus('clear');
                            }
                        }, 3000);
                        return; // Success!
                    }

                    // Handle specific error cases
                    if (commitResponse.status === 409) {
                        lastError = 'File was modified by someone else. Retrying with fresh data...';
                        console.warn(`Attempt ${attempt}: 409 Conflict - fetching fresh SHA and retrying...`);
                        
                        if (attempt < maxRetries) {
                            // Wait a bit before retrying (exponential backoff)
                            await new Promise(resolve => setTimeout(resolve, 500 * attempt));
                            continue; // Retry with fresh SHA
                        }
                    } else if (commitResponse.status === 401) {
                        throw new Error('Authentication failed. Please check your GitHub token.');
                    } else if (commitResponse.status === 403) {
                        const errorData = await commitResponse.json().catch(() => ({}));
                        if (errorData.message?.includes('rate limit')) {
                            throw new Error('GitHub API rate limit exceeded. Please try again later.');
                        }
                        throw new Error('Permission denied. Please check your token has repo access.');
                    } else {
                        const errorData = await commitResponse.json().catch(() => ({}));
                        throw new Error(errorData.message || `Commit failed: ${commitResponse.status}`);
                    }

                } catch (error) {
                    lastError = error.message;
                    console.error(`Attempt ${attempt} failed:`, error);
                    
                    // Don't retry on auth errors
                    if (error.message.includes('Authentication') || error.message.includes('Permission')) {
                        break;
                    }
                    
                    if (attempt < maxRetries) {
                        await new Promise(resolve => setTimeout(resolve, 500 * attempt));
                    }
                }
            }

            // All retries exhausted or non-retryable error
            console.error('Save failed after all retries:', lastError);
            updateSaveStatus('error', lastError.substring(0, 30));
            
            // Show user-friendly error message
            let userMessage = 'Failed to save: ' + lastError;
            if (lastError.includes('409') || lastError.includes('modified')) {
                userMessage = 'Save failed: The file was updated by someone else. Please refresh and try again.';
            } else if (lastError.includes('token') || lastError.includes('Authentication')) {
                userMessage = 'Save failed: Your GitHub token is invalid or expired. Please reconnect.';
            }
            
            alert(userMessage);
        }

        // Initialize auto-save checkbox from localStorage
        function initAutoSave() {
            const checkbox = document.getElementById('autoSaveCheckbox');
            if (checkbox) {
                checkbox.checked = localStorage.getItem('autosave_enabled') === 'true';
                checkbox.addEventListener('change', (e) => {
                    localStorage.setItem('autosave_enabled', e.target.checked);
                });
            }
        }

        // Login / Logout functionality
        let currentUser = null;

        async function checkLoginStatus() {
            const token = localStorage.getItem('github_token');
            if (!token) {
                showLoginModal();
                return;
            }
            
            // Verify token and get user info
            try {
                const response = await fetch('https://api.github.com/user', {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });
                
                if (response.ok) {
                    const user = await response.json();
                    currentUser = user;
                    showLoggedInState(user.login);
                } else {
                    // Token invalid
                    localStorage.removeItem('github_token');
                    showLoginModal();
                }
            } catch (error) {
                console.error('Failed to verify token:', error);
                showLoginModal();
            }
        }

        function showLoginModal() {
            document.getElementById('loginOverlay').classList.add('active');
            document.getElementById('userStatus').style.display = 'none';
        }

        function hideLoginModal() {
            document.getElementById('loginOverlay').classList.remove('active');
        }

        function showLoggedInState(username) {
            hideLoginModal();
            document.getElementById('userStatus').style.display = 'flex';
            document.getElementById('username').textContent = username;
        }

        async function connectGitHub() {
            const tokenInput = document.getElementById('tokenInput');
            const token = tokenInput.value.trim();
            
            if (!token) {
                alert('Please enter a GitHub token');
                return;
            }
            
            if (!token.startsWith('ghp_') && !token.startsWith('github_pat_')) {
                alert('Invalid token format. Token should start with "ghp_" or "github_pat_"');
                return;
            }
            
            // Verify token
            const btn = document.querySelector('.login-btn');
            const originalText = btn.textContent;
            btn.textContent = 'Connecting...';
            btn.disabled = true;
            
            try {
                const response = await fetch('https://api.github.com/user', {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });
                
                if (response.ok) {
                    const user = await response.json();
                    localStorage.setItem('github_token', token);
                    currentUser = user;
                    showLoggedInState(user.login);
                    tokenInput.value = '';
                    console.log('Connected as:', user.login);
                } else {
                    alert('Invalid token. Please check your token and try again.');
                }
            } catch (error) {
                console.error('Connection failed:', error);
                alert('Failed to connect. Please try again.');
            } finally {
                btn.textContent = originalText;
                btn.disabled = false;
            }
        }

        function logout() {
            localStorage.removeItem('github_token');
            currentUser = null;
            showLoginModal();
            console.log('Logged out');
        }

        // Handle Enter key in token input
        document.getElementById('tokenInput')?.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                connectGitHub();
            }
        });

        // Initialize
        init();
        initAutoSave();
        checkLoginStatus();
    </script>
</body>
</html>
